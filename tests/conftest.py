"""
Конфигурационный модуль тестового окружения (`tests.conftest.py`) для проекта WorkCalendarClient.

Назначение:
- Централизовать настройки и фикстуры, общие для всех тестовых модулей.
- Обеспечить изолированные тестовые среды (HTTP‑клиент, БД) для надёжности тестов.
- Упростить повторное использование настроек в разных тестовых сценариях.
- Гарантировать корректную инициализацию и очистку ресурсов.

Ключевые возможности:
1. **HTTP‑тестирование**: фикстура `test_client` создаёт изолированный `TestClient`, имитирующий запросы к FastAPI‑приложению с тестовым `lifespan`.
2. **Тестовая БД**: фикстура `test_db_engine` настраивает SQLite в памяти, применяет миграции и очищает соединения после сессии.
3. **Жизненный цикл БД**: `test_lifespan` управляет инициализацией (импорт моделей, миграции) и логированием старта/остановки.
4. **Глобальный клиент**: экспортируемый `client` позволяет простые тесты без сложной настройки (с оговоркой на отсутствие изоляции БД).

Используемые технологии:
- FastAPI + `TestClient` для HTTP‑тестов.
- SQLAlchemy + `create_engine` для управления БД.
- Alembic (`run_migrations`) для миграций схемы.
- pytest (`@pytest.fixture`) для управления ресурсами.
- асинхронные контекстные менеджеры (`@asynccontextmanager`) для `lifespan`.

Рекомендации по использованию:
- Для тестов с БД используйте `test_db_engine` и `test_client`.
- Для простых HTTP‑тестов без БД можно использовать глобальный `client`.
- Добавляйте новые фикстуры в этот модуль для повторного использования.

Ограничения и примечания:
- Глобальный `client` не изолирует БД — используйте осторожно.
- Все фикстуры с `scope="session"` экономят время, но требуют корректной очистки.
- Замените `print()` на `logger` для структурированного вывода.
- SQLite в памяти обеспечивает скорость, но не поддерживает все функции реальных БД.
"""


import pytest
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.testclient import TestClient
from sqlalchemy import create_engine

from app import app, Base
from app.core import run_migrations

# Основной клиент (без изоляции БД — использовать осторожно)
client = TestClient(app)

# Тестовая БД в памяти
TEST_DATABASE_URL = "sqlite:///:memory:"
test_engine = create_engine(TEST_DATABASE_URL)

@asynccontextmanager
async def test_lifespan(app):
    """
    Обеспечивает корректную инициализацию и очистку ресурсов в тестовой среде.

    Выполняет следующие действия:
    1. Импортирует SQLAlchemy‑модели (необходимо для корректной работы Alembic).
    2. Запускает миграции Alembic через `run_migrations()` для подготовки схемы тестовой БД.
    3. Передаёт управление приложению (`yield`) до его завершения.

    Предназначен для использования как параметр `lifespan` в `FastAPI()` при тестировании.


    Args:
        app (FastAPI): приложение, для которого управляется жизненный цикл.

    Yields:
        None: управление приложением на время его активной работы.
    """
    import app.models.calendar
    print("Запуск миграций Alembic...") # заменить на logger
    run_migrations(test_engine)
    print("Миграции применены.") # заменить на logger
    yield
    print("Приложение завершает работу.") # заменить на logger


@pytest.fixture(scope="session")
def test_client():
    """
    Предоставляет изолированный тестовый HTTP‑клиент на всю сессию pytest.

    Порядок инициализации:
    1. Создаёт новое FastAPI‑приложение (`test_app`) с тестовым обработчиком жизненного цикла (`test_lifespan`).
    2. Подключает основной роутер приложения (`app.router`), обеспечивая доступность всех эндпоинтов.
    3. Обертывает приложение в `TestClient` из `fastapi.testclient` для симуляции HTTP‑взаимодействия.
    4. Предоставляет клиент в качестве ресурса для тестов через `yield`.
    5. Автоматически закрывает клиент по выходу из контекста (`with`).

    Использование: внедряется в тестовые функции как аргумент для выполнения HTTP‑запросов.

    Yields:
        TestClient: экземпляр тестового клиента FastAPI.
    """
    test_app = FastAPI(lifespan=test_lifespan)
    test_app.include_router(app.router)

    with TestClient(test_app) as client:
        yield client


@pytest.fixture(scope="session")
def test_db_engine():
    """
    Обеспечивает изолированную тестовую среду БД для всей сессии pytest.

    Порядок действий:
    1. Создаёт все необходимые таблицы в тестовой БД на основе метаданных SQLAlchemy (`Base.metadata`).
    2. Применяет все pending-миграции через функцию `run_migrations()`.
    3. Предоставляет готовый к использованию тестовый движок (`test_engine`) в качестве ресурса для тестов.
    4. После завершения всех тестов в сессии корректно закрывает соединение (`dispose()`).

    Использование: внедряется в тестовые функции как аргумент.

    Yields:
        Engine: экземпляр движка SQLAlchemy, указывающий на тестовую БД.
    """
    Base.metadata.create_all(test_engine)
    run_migrations(test_engine)
    yield test_engine
    test_engine.dispose()


